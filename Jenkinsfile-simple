pipeline {
    agent any
    
    environment {
        // GitHubä»“åº“é…ç½®
        GIT_REPO = 'git@github.com:shijinke1990/jenkins_demo.git'
        GIT_BRANCH = 'main'
        // é˜¿é‡Œäº‘æœåŠ¡å™¨é…ç½®
        ALIYUN_HOST = 'ä½ çš„é˜¿é‡Œäº‘æœåŠ¡å™¨IP'
        ALIYUN_USER = 'root'  // æˆ–å…¶ä»–ç”¨æˆ·å
        DEPLOY_PATH = '/var/www/html'  // éƒ¨ç½²ç›®å½•
        NODE_VERSION = '20'  // Node.jsç‰ˆæœ¬
    }
    
    // æš‚æ—¶æ³¨é‡Šæ‰toolsé…ç½®ï¼Œé¿å…NodeJSå·¥å…·é…ç½®é—®é¢˜
    // tools {
    //     nodejs "Node-${NODE_VERSION}"
    // }
    
    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo 'å¼€å§‹ä»GitHubæ£€å‡ºä»£ç ...'
                echo "ä»“åº“åœ°å€: ${GIT_REPO}"
                echo "åˆ†æ”¯: ${GIT_BRANCH}"
                
                // æ¸…ç†å·¥ä½œç©ºé—´
                deleteDir()
                
                // ä»GitHubæ£€å‡ºä»£ç 
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'github-ssh-key' // éœ€è¦åœ¨Jenkinsä¸­é…ç½®GitHub SSHå¯†é’¥
                    ]]
                ])
                
                // æ˜¾ç¤ºå½“å‰æäº¤ä¿¡æ¯
                script {
                    def gitCommit = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    def gitAuthor = sh(returnStdout: true, script: 'git log -1 --pretty=format:"%an"').trim()
                    def gitMessage = sh(returnStdout: true, script: 'git log -1 --pretty=format:"%s"').trim()
                    echo "æäº¤ID: ${gitCommit}"
                    echo "æäº¤ä½œè€…: ${gitAuthor}"
                    echo "æäº¤ä¿¡æ¯: ${gitMessage}"
                }
            }
        }
        
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                echo 'æ£€æŸ¥æ„å»ºç¯å¢ƒ...'
                script {
                    // æ£€æŸ¥Node.jså’Œnpmæ˜¯å¦å¯ç”¨
                    sh 'node --version || echo "Node.jsæœªå®‰è£…"'
                    sh 'npm --version || echo "npmæœªå®‰è£…"'
                    
                    // å®‰è£…Node.jsï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
                    try {
                        sh 'node --version'
                    } catch (Exception e) {
                        echo 'å®‰è£…Node.js...'
                        sh '''
                            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                            sudo apt-get install -y nodejs
                        '''
                    }
                }
            }
        }
        
        stage('å®‰è£…ä¾èµ–') {
            steps {
                echo 'å®‰è£…é¡¹ç›®ä¾èµ–...'
                script {
                    if (isUnix()) {
                        sh '''
                            # å®‰è£…pnpm
                            npm install -g pnpm
                            # å®‰è£…é¡¹ç›®ä¾èµ–
                            pnpm install
                        '''
                    } else {
                        bat '''
                            npm install -g pnpm
                            pnpm install
                        '''
                    }
                }
            }
        }
        
        stage('ä»£ç æ£€æŸ¥') {
            steps {
                echo 'æ‰§è¡Œä»£ç æ£€æŸ¥...'
                script {
                    try {
                        if (isUnix()) {
                            sh 'pnpm lint'
                        } else {
                            bat 'pnpm lint'
                        }
                    } catch (Exception e) {
                        echo "ä»£ç æ£€æŸ¥è­¦å‘Š: ${e.getMessage()}"
                        // ä¸é˜»æ­¢æ„å»ºæµç¨‹
                    }
                }
            }
        }
        
        stage('æ„å»ºé¡¹ç›®') {
            steps {
                echo 'å¼€å§‹æ„å»ºé¡¹ç›®...'
                script {
                    if (isUnix()) {
                        sh 'pnpm build'
                    } else {
                        bat 'pnpm build'
                    }
                }
                
                // éªŒè¯æ„å»ºäº§ç‰©
                script {
                    if (fileExists('dist/index.html')) {
                        echo 'âœ… æ„å»ºæˆåŠŸï¼Œdistç›®å½•å·²ç”Ÿæˆ'
                    } else {
                        error 'âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°dist/index.html'
                    }
                }
            }
        }
        
        stage('æ‰“åŒ…æ„å»ºäº§ç‰©') {
            steps {
                echo 'æ‰“åŒ…æ„å»ºäº§ç‰©...'
                script {
                    if (isUnix()) {
                        sh '''
                            # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å‹ç¼©åŒ…
                            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                            tar -czf "dist-${TIMESTAMP}.tar.gz" dist/
                            # åˆ›å»ºä¸€ä¸ªé€šç”¨åç§°çš„é“¾æ¥
                            ln -sf "dist-${TIMESTAMP}.tar.gz" dist.tar.gz
                            echo "æ„å»ºåŒ…: dist-${TIMESTAMP}.tar.gz"
                        '''
                    } else {
                        // Windowsç¯å¢ƒä½¿ç”¨PowerShellå‹ç¼©
                        powershell '''
                            $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
                            Compress-Archive -Path .\\dist\\* -DestinationPath "dist-$timestamp.zip" -Force
                            Copy-Item "dist-$timestamp.zip" -Destination "dist.zip" -Force
                            Write-Host "æ„å»ºåŒ…: dist-$timestamp.zip"
                        '''
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°é˜¿é‡Œäº‘') {
            steps {
                echo 'å¼€å§‹éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨...'
                script {
                    // ä½¿ç”¨SSHå‡­æ®éƒ¨ç½²
                    sshagent(['aliyun-ssh-key']) {
                        if (isUnix()) {
                            sh """
                                # ä¸Šä¼ æ„å»ºäº§ç‰©
                                scp -o StrictHostKeyChecking=no dist.tar.gz ${ALIYUN_USER}@${ALIYUN_HOST}:/tmp/
                                
                                # è¿æ¥æœåŠ¡å™¨å¹¶éƒ¨ç½²
                                ssh -o StrictHostKeyChecking=no ${ALIYUN_USER}@${ALIYUN_HOST} '
                                    echo "å¼€å§‹éƒ¨ç½²..."
                                    
                                    # å¤‡ä»½æ—§ç‰ˆæœ¬
                                    if [ -d ${DEPLOY_PATH}_backup ]; then
                                        rm -rf ${DEPLOY_PATH}_backup
                                    fi
                                    if [ -d ${DEPLOY_PATH} ]; then
                                        mv ${DEPLOY_PATH} ${DEPLOY_PATH}_backup
                                        echo "å·²å¤‡ä»½æ—§ç‰ˆæœ¬"
                                    fi
                                    
                                    # åˆ›å»ºéƒ¨ç½²ç›®å½•
                                    mkdir -p ${DEPLOY_PATH}
                                    
                                    # è§£å‹æ–°ç‰ˆæœ¬
                                    cd ${DEPLOY_PATH}
                                    tar -xzf /tmp/dist.tar.gz --strip-components=1
                                    echo "æ–°ç‰ˆæœ¬è§£å‹å®Œæˆ"
                                    
                                    # è®¾ç½®æƒé™
                                    chown -R www-data:www-data ${DEPLOY_PATH}
                                    chmod -R 755 ${DEPLOY_PATH}
                                    
                                    # é‡å¯Nginxï¼ˆå¦‚æœä½¿ç”¨ï¼‰
                                    if command -v nginx > /dev/null; then
                                        systemctl reload nginx || service nginx reload
                                        echo "Nginxå·²é‡è½½"
                                    fi
                                    
                                    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                                    rm -f /tmp/dist.tar.gz
                                    
                                    echo "éƒ¨ç½²å®Œæˆï¼"
                                '
                            """
                        } else {
                            // Windowsç¯å¢ƒä½¿ç”¨pscpå’Œplink
                            bat """
                                pscp -i "C:\\path\\to\\private\\key.ppk" -scp dist.zip ${ALIYUN_USER}@${ALIYUN_HOST}:/tmp/
                                plink -i "C:\\path\\to\\private\\key.ppk" ${ALIYUN_USER}@${ALIYUN_HOST} "cd ${DEPLOY_PATH} && unzip -o /tmp/dist.zip && rm /tmp/dist.zip"
                            """
                        }
                    }
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                echo 'æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥...'
                script {
                    // ç­‰å¾…æœåŠ¡å¯åŠ¨
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // æ£€æŸ¥ç½‘ç«™æ˜¯å¦æ­£å¸¸è®¿é—®
                    def response = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' http://${ALIYUN_HOST} || echo '000'",
                        returnStdout: true
                    ).trim()
                    
                    echo "HTTPå“åº”ç : ${response}"
                    
                    if (response == '200') {
                        echo 'âœ… ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼Œè®¿é—®æ­£å¸¸ï¼'
                    } else if (response == '000') {
                        echo 'âš ï¸  æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œé˜²ç«å¢™è®¾ç½®'
                    } else {
                        echo "âš ï¸  ç½‘ç«™è®¿é—®å¼‚å¸¸ï¼ŒHTTPçŠ¶æ€ç : ${response}"
                        // ä¸é˜»æ­¢éƒ¨ç½²æµç¨‹ï¼Œåªæ˜¯è­¦å‘Š
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼'
            script {
                // å‘é€ç®€å•é€šçŸ¥ï¼ˆä½¿ç”¨Jenkinså†…ç½®é‚®ä»¶åŠŸèƒ½ï¼‰
                try {
                    mail (
                        to: 'your-email@example.com',
                        subject: "âœ… éƒ¨ç½²æˆåŠŸ: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                        body: "é¡¹ç›® ${env.JOB_NAME} æ„å»º ${env.BUILD_NUMBER} å·²æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ã€‚\n\næ„å»ºæ—¶é—´: ${new Date()}\næ„å»ºURL: ${env.BUILD_URL}"
                    )
                } catch (Exception e) {
                    echo "é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥: ${e.getMessage()}"
                }
            }
        }
        
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼'
            script {
                // å‘é€å¤±è´¥é€šçŸ¥
                try {
                    mail (
                        to: 'your-email@example.com',
                        subject: "âŒ éƒ¨ç½²å¤±è´¥: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                        body: "é¡¹ç›® ${env.JOB_NAME} æ„å»º ${env.BUILD_NUMBER} éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—ã€‚\n\næ„å»ºæ—¶é—´: ${new Date()}\næ„å»ºURL: ${env.BUILD_URL}"
                    )
                } catch (Exception e) {
                    echo "é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥: ${e.getMessage()}"
                }
            }
        }
        
        always {
            echo 'æ¸…ç†å·¥ä½œç©ºé—´...'
            script {
                // æ¸…ç†æ„å»ºäº§ç‰©ï¼Œä½†ä¿ç•™æºä»£ç 
                sh 'rm -f *.tar.gz *.zip 2>/dev/null || true'
                echo 'æ¸…ç†å®Œæˆ'
            }
        }
    }
}